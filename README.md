# Twitter

## 1. Тема и целевая аудитория
### 1.1. Тема
[Twitter](https://twitter.com/) — американский сервис микроблогов и социальная сеть, в которой пользователи публикуют сообщения, известные как «твиты», и взаимодействуют с ними.

### 1.2. Целевая аудитория

| Целевая аудитория (значения за прошедший месяц - сентябрь) | Количество |
|-|-|
| Количество посетителей сайта в месяц [[1]](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/overview/website-performance/*/999/1m?webSource=Total&key=twitter.com)| 6,8 млрд |
| Количество посетителей сайта в день [[2]](https://www.statista.com/statistics/970920/monetizable-daily-active-twitter-users-worldwide/) (статистика за второй квартал 2022 года)| 237,8 млн |
| Среднее количество страниц за визит [[1]](https://www.similarweb.com/ru/website/twitter.com/#traffic)| 10,39 |
| Среднее время просмотра [[1]](https://www.similarweb.com/ru/website/twitter.com/#traffic)| 10м 58с  |

| Распределение пользователей по миру (топ-5) за прошедший месяц[[1]](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/overview/website-performance/*/999/1m?webSource=Total&key=twitter.com)   | % |
|-----------------------------------|-----------|
| Соединенные Штаты Америки | 25,33 |
| Япония | 15,40 |
| Великобритания | 5,47 |
| Бразилия | 3,94 |
| Канада | 3,02 |
| Остальное страны | 46,84 |

### 1.3. MVP
Минимальные требования для MVP:
* Регистрация и авторизация пользователя;
* Публикация твита
    * Максимальное количество прикрепленных вложений - 4 [[3]](https://help.twitter.com/ru/using-twitter/tweeting-gifs-and-pictures#:~:text=%D0%9A%20%D0%BE%D0%B4%D0%BD%D0%BE%D0%BC%D1%83%20%D1%82%D0%B2%D0%B8%D1%82%D1%83%20%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE%20%D0%BF%D1%80%D0%B8%D0%BA%D1%80%D0%B5%D0%BF%D0%B8%D1%82%D1%8C%20%D0%B4%D0%BE%204%C2%A0%D1%84%D0%BE%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%B9.);
    * Максимальная длина сообщения - 280 символов [[4]](https://developer.twitter.com/en/docs/counting-characters#:~:text=In%20most%20cases%2C%20the%20text%20content%20of%20a%20Tweet%20can%20contain%20up%20to%20280%20characters%20or%20Unicode%20glyphs) ;
    * Максимальный размер прикрепленных вложений - 5 mb [[5]](https://help.twitter.com/en/using-twitter/tweeting-gifs-and-pictures#:~:text=Photos%20can%20be%20up%20to%205MB%3B%20animated%20GIFs%20can%20be%20up%20to%205MB%20on%20mobile%2C%20and%20up%20to%2015MB%20on%20web.).
* Проставление лайков
* Просмотр ленты (твитов)

## 2. Расчет нагрузки
### 2.1. Продуктовые метрики

#### 2.1.1 Регистрация и авторизация
Основываясь на данных из источника [[2]](https://www.statista.com/statistics/970920/monetizable-daily-active-twitter-users-worldwide/) (статистика за второй квартал 2022 года), количество пользователей в день составляется 237,8 млн. По аппроксимирующей статистике [[6]](https://www.statista.com/statistics/303681/twitter-users-worldwide/) суммарное количество пользователей твиттера за 2021 год составляло 322,4 млн, а за 2022 год - 329 млн. Значит, за 2022 год приблизительное значение зарегистрировашихся пользователей составит 6,6 млн. Значит, в день будет регистрироваться примерно:

`6,6 * 10 ^ 6 / 365 = 18,082 тыс в день`

Суммирая авторизацию и регистрацию, получаем около 238 млн/день.

#### 2.1.2 Публикация твита
По статистике, приведенной в источнике [[7]](https://www.loginradius.com/blog/engineering/handling-cheapest-fuel-data/#:~:text=Twitter%3A%20456%2C000%20tweets%20sent%20or%20created), в минуту создается порядка 456 тыс. твитов. Исходя из этого, можно сделать вывод, что в день создается: 

`456 * 10 ^ 3 *60 * 24 = 656,64 млн в день`
#### 2.1.3 Проставление лайков
По статистике [[7]](https://follows.com/blog/2022/01/how-tweets-safe-day#:~:text=Favorites%20(now%20likes)%20seemed%20to%20have%20a%20limit%20of%20about%201%2C000%20per%20day) (сомнительный источник, официальной информации нет) пользователю в день разрешено проставлять 1000 лайков. Учитывая, что, как и в других популярных соц. сетях, в Твиттере также есть боты, можно сказать, что 10 лайков в день - средний показатель по пользователям. Исходя их этого, можно сделать вывод, что в день проставляется лайков:

`10 * 237,8 ^ 10 * 6 = 2,37 млрд в день`
#### 2.1.4 Просмотр ленты
Лента загружается через запрос к API по следующему URL: "https://twitter.com/i/api/2/timeline/home.json...", где далее расположены query-параметры запроса. Количество загружаемых постов варьировалось от просмотра ленты:
* При первой загрузке страницы было загружено 27 твитов;
* Следующая загрузка - 36 твитов;
* Третья загрузка - 38 твитов;
* Четвертая загрузка - 43 твита.

Наблюдается зависимость: при большем просмотре твитов увеличивается количество загружаемых твитов в одном запросе. В среднем, в следующем запросе количество твитов увеличивается на 4.

Средняя скорость чтения человека - 200 слов в минуту [[8]](https://ru.wikipedia.org/wiki/%D0%A1%D0%BA%D0%BE%D1%80%D0%BE%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D0%B5#:~:text=%D1%81%D1%80%D0%B5%D0%B4%D0%BD%D1%8F%D1%8F%20%D1%81%D0%BA%D0%BE%D1%80%D0%BE%D1%81%D1%82%D1%8C%20%D1%80%D0%B0%D0%B2%D0%BD%D1%8F%D0%B5%D1%82%D1%81%D1%8F%20201%20%D1%81%D0%BB%D0%BE%D0%B2%D1%83%20%D0%B2%20%D0%BC%D0%B8%D0%BD%D1%83%D1%82%D1%83), что равняется 1400 знакам. Человек может обрабатывать от 10 до 12 изображений в секунду [[9]](https://en.wikipedia.org/wiki/Frame_rate#:~:text=can%20process%2010%20to%2012%20images%20per%20second). Значит, среднее время просмотра одного твита - около 15 секунд. Как было выяснено в пункте ["Целевая аудитория"](#12-целевая-аудитория) пользователь тратит в среднем 10 минут 58 секунд в день, используя Твиттер. За это время пользователь мог бы посмотреть 44 твита, если бы останавливал свое внимание на каждом. Допустим, что каждый 3 твит был пропущен, тогда пользователь просмотрит в день порядка 90 твитов. Ориентируясь на количество твитов в загрузках, в среднем пользователю понадобится 3 загрузки твитов. 
Посчитаем количество запросов в день:

`3 * 237,8 (количество пользователей в день) = 713,4 млн`

#### Сводная таблица количества действий пользователя по типам в день
| Тип запроса | Среднее количество в день|
|-|-|
| Регистрация и авторизация | 238 млн |
| Публикация твита  | 656,64 млн |
| Проставление лайков | 2,378 млрд |
| Просмотр ленты | 713,4 млн |

### 2.2. Технические метрики
#### 2.2.1 Размер хранения
Рассчитаем размер одного твита. Один символ занимает один байт памяти. Предположим, что длиная среднего твита - 120 символов. Пользователи твиттера редко прикрепляют фотографии к твитам, поэтому предположим, что на один пост полагается порядка 0,8 фотографии. При максимальном значении одного вложения в 5 Мб предположим, что размер вложения будет 3,5 Мб. Таким образом, средний размер поста:

`3,5 * 0,8 + 120 / (1024 * 1024) = 2,9 Мб`

По данным статьи [[10]](https://www.renolon.com/number-of-tweets-per-day/#:~:text=How%20Many%20Tweet%20Sent%20Per%20Day%20of%202013%2D2022) суммарное количество твитов составляет: 

`340 + 500 + 546 + 592 + 634 + 683 + 729 + 775 + 821 + 867 = 6,487 млрд`

Тогда размер хранилища для твитов составит:

`6,487 * 10 ^ 9 * 2,9 = 1,88 * 10 ^ 10 Мб = 17,52 Пб`

Помимо твитов, место в хранилище занимает профили пользователей, их контактные данные, аватарка профиля, список твитов.

| Поле | Занимаемое место на диске|
|-|-|
| Id | 4 байта |
| Никнейм | 30 символов = 30 байт |
| Хешированный пароль | 32 байта |
| Почтовый адрес | 4 байта |
| Дата рождения | datetime = 4 байта|
| Описание | 100 символов = 30 байт|
| Ссылка на аватар |  uuid = 16 байт|
| Суммарно | 46,3 кБ |

Общее количество пользователей Твиттера - 1,3 млрд [[11]](https://ru.wikipedia.org/wiki/%D0%A2%D0%B2%D0%B8%D1%82%D1%82%D0%B5%D1%80#:~:text=1%2C3%20%D0%BC%D0%BB%D1%80%D0%B4%20(%D0%B7%D0%B0%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)).

Тогда размер хранилища для пользователей составит: 

`46,3 * 1,3 * 10 ^ 9 = 56,06 Тб`


#### 2.2.2 Объем прироста хранилища

Твиттер генерирует порядка 12 ТерраБайт новых данных в день [[12]](https://www.loginradius.com/blog/engineering/handling-cheapest-fuel-data/).


#### 2.2.3 Сетевой трафик

При расчете сетевого трафика будем учитывать запросы, которые существенно влияют на сеть - публикация твита и загрузка ленты. 

Как было выяснено [ранее](#сводная-таблица-количества-действий-пользователя-по-типам-в-день), один твит занимает порядка `2,9 Мб`, в среднем в день публикуют около 656,64 млн твитов. Значит, нагрузка на сеть публикацией твитов составит:

`2,9 Мб * 656,64 * 10 ^ 6 / (24 * 60 * 60) = 22 040 Мб/с = 21,52 Гб/с`

В среднем за [день](#сводная-таблица-количества-действий-пользователя-по-типам-в-день) происходит 713,4 млн запросов на просмотр ленты. Расчитаем, какая нагрузка на сеть происходит из-за загрузки ленты:

`2,9 Мб * 90 (среднее количество просматриваемых твитов) * 713,4 * 10 ^ 6 / (24 * 60 * 60) = 2104 Гб/с`

Суммарная нагрузка на сеть составит `2125,52 Гб/cек`

| Тип запроса | Гб/сек |
|-|-|
| Публикация твита | 21,52 |
| Просмотр ленты  | 2104 |

#### 2.2.4 RPS
##### 2.2.3.1 Регистрация и авторизация

Основываясь на данных из [таблицы](#сводная-таблица-количества-действий-пользователя-по-типам-в-день), rps по регистрации и авторизации:

* Расчет RPS = `238 / (60 * 60 * 24) = 2754 rps`

##### 2.2.3.2 Публикация твита
Основываясь на данных из [таблицы](#сводная-таблица-количества-действий-пользователя-по-типам-в-день), rps по публикации твита:

* Расчет RPS = `656,64 * 10 ^ 6 / 24 * 60 * 60 = 7600 rps`

##### 2.2.3.3 Проставление лайков

Основываясь на данных из [таблицы](#сводная-таблица-количества-действий-пользователя-по-типам-в-день), rps по публикации твита:

* Расчет RPS = `2,378 * 10 ^ 9 / 24 * 60 * 60 = 27523 rps`
##### 2.2.3.4 Просмотр ленты
Основываясь на данных из [таблицы](#сводная-таблица-количества-действий-пользователя-по-типам-в-день), rps по публикации твита:

* Расчет RPS = `713,4 * 10 ^ 6 / 24 * 60 * 60 = 8256 rps`

#### RPS по типам запросов
| Тип запроса | RPS |
|-|-|
| Регистрация и авторизация | 2754 |
| Публикация твита | 7600 |
| Проставление лайков | 27523 |
| Просмотр ленты  | 8256 |

Суммарное RPS составляет 46133 RPS.

### 2.2.5 Пиковая нагрузка RPS
Для расчета пиковой нагрузки нужно изменить математическую модель трафика, потому что ранее расчет проводился по средним значениям, что отличается от реальных показателей сервиса.

Проведем расчет пикового RPS сервиса, основываясь на метриках реального [сервиса](https://pulse.mail.ru/), предоставленного моим наставником - Павлом Шипиловым. 

![Суточные метрики RPS](https://user-images.githubusercontent.com/92160117/206008845-3b900f17-366c-4994-9034-1a3ce90263be.png)

На суточных метриках видно, что максимальное значение RPS составляет примерно 9200, минимальное значение равно примерно 1200.

Выведем соотношение между средним значением и пиковым:
```
Среднее значение метрики, приведенной выше = (9200 + 1200) / 2 = 5200

Отношение между пиковой и средней нагрузками = 9200 / 5200 = 1,77
```

Воспользуемся полученным отношением и определим пиковую нагрузку:
```
Суммарное RPS * соотношение = 46 133 * 1,77 = 81 620 RPS
```

#### Пиковый RPS по типам запросов
| Тип запроса | RPS |
|-|-|
| Регистрация и авторизация | 4875 |
| Публикация твита | 13452 |
| Проставление лайков | 48715 |
| Просмотр ленты  | 14613 |

#### Пиковый сетевой трафик
| Тип запроса | Гб/сек |
|-|-|
| Публикация твита | 38,1 |
| Просмотр ленты  | 3724 |

## 3. Логическая схема базы данных

![Логическая схема БД](https://user-images.githubusercontent.com/92160117/206008035-e06d8650-5fb7-4a0c-9bea-79a85a60bc71.jpg)

Сущности базы данных:

* Пользователь - основные сведения о пользователе. PrimaryKey - UserID
* Пост - твит пользователя. PrimaryKey - PostID, содержит информацию о пользователе (Many2Many), содержании, количестве лайков, вложении (Many2Many), дате публикации.
* Лайк - PrimaryKey - LikeID, информация о пользователе (ForeignKey), посте (ForeignKey).
* Вложение - информация о вложении, PrimaryKey - AttachmentID, ссылка на сам файл в файловом хранилище, дата создания и хеш вложения для хранения только уникальных вложений.
* Сессия - информация о сессии пользователя. PrimaryKey - SessionID, информация о пользователе (ForeignKey), уникальный сессионный токен.

## 4. Физическая схема базы данных

![Физическая схема БД](https://user-images.githubusercontent.com/92160117/206007978-eb75db9a-4375-4809-a783-d6f40932de6d.jpg)

## 4.1 Вложения

Вложения разместим в облачном хранилище AmazonS3, в базе данных будем хранить только путь до вложения. Также предлагается перед загрузкой высчитывать хеш от загружаемого вложения для избегания хранения дублирующихся вложений и уменьшения итоговой стоимости аренды облачного хранилища.

## 4.2 Лайки и посты 

Таблица постов является самой большой в проекте, поэтому хранение этой таблицы на одном сервере не представляется возможным. Самыми нагруженными постами будут недавно опубликованные посты, поэтому можно использовать базу данных PostgreSQL вместе с ее встроенными механизмом Range Partitioning, позволяющий партиционировать данные на основе диапазонов даты. 

Для хранения недавно опубликованных постов необходимо предоставить наиболее производительный сервер. Предлагается шардировать данные следующим образом: 
* посты, начиная с текущей даты и до недели назад, размещаются на самом производительном сервере
* остальное партиционирование по дате происходит с помощью геометрической прогрессии - чем дальше от текущей даты, тем больше данных хранит в себе сервер, ведь нагрузка на него будет уменьшаться со временем


## 4.3 Лайки:

Проставление лайков является самой нагруженной операцией данного сервиса. В то же время необходимо сохранить реалиционную модель базы данных для того, чтобы упростить следующие возможные запросы:
* просмотреть, какой пользователь лайкнул пост
* просмотреть, какие посты лайкал этот пользователь

Для того, чтобы облегчить такие запросы, будем хранить эти данные также в PostgreSQL, чтобы была возможность использовать `JOIN` для запросов.

Размещение информации о лайках также позволит аналитикам более просто получать данные для дальнейшего совершенствования сервиса.

## 4.4 Сессии

Запись сессии представляет собой аналогичную лайку пару ключ - значение, где ключом выступает SessionID, а значением - UserID. Для хранения таких записей предлагается использовать NoSQL базу данных - Redis, так как нагрузка будет меньше, чем на взаимодействие с лайками, и потеря данных не будет являться критичным событием.

## 4.5 Пользователи

Пользователей также, как и посты, будем хранить в PostgreSQL. Один сервер не справится с нагрузкой, поэтому будем шардировать базу данных. Шардинг проведем по диапазонам UserID

## 4.6 Индексы

Для ускорения чтения из базы данных предлагается использовать следующие индексы: 

* AttahcmentID - для быстрого поиска вложения по ID (загрузка вложения в посте, скачивание вложения на устройство) 
* Nickname - для быстрого поиска человека по его никнейму
* UserID в таблице Post - для быстрого поиска автора поста

## 5. Технологии

Использование микросервисной архитектуры увеличивает скорость разработки, уменьшает проблемы при последующем обслуживании сервиса, облегчает масштабирование сервиса, а также увеличение отказоустойчивости.

| Технологии | Область применения | Мотивационная часть |
|-|-|-|
| TypeScript + React | FrontEnd | Универсальный и эффективный набор технологий для разработки фронтенда |
| gRPC | Backend | Высокоэффективный формат обмена сообщения с высокой степенью упаковки для сериализации данных. Позволяет существенно увеличить скорость передачи данных между сервисами, примерно в 7-10 раз. Использование HTTP 2 вместо HTTP 1.1 |
| Go | Backend | Более простая разработка, чем в других комплируемых языках. Поддержка многопоточности "из коробки". Высокая производительность. |
| Kafka/RabbitMQ | Очередь для микросервиса лайков | Добиться большей производительности можно следующим путем - изменять текущее значение лайков на странице, просматриваемой пользователем, с помощью TypeScript, а запись об этом измении отправлять в брокер сообщений, который в свою очередь отправит эти сообщения в микросервис |
| PostgreSQL | Backend | Возможность шардирования и реплицирования, высокая производительность, обширный функционал, реляционность |
| Amazon S3 | Backend | Высокая производительность, масштабируемость, высокая надежность, низкие затраты |
| Jagger | Backend | Для отслеживания запроса между микросервисами  |
| Graylog | Backend | Логирование сервисов |
| Prometheus + Grafana | Backend | Мониторинг сервисов |


## 6. Схема проекта

![Схема проекта](https://user-images.githubusercontent.com/92160117/206009016-a689afee-22cc-44f1-85db-2cc66c991bf6.jpg)

## 7. Список оборудования

**Облачное хранилище данных**:

Как было выяснено ранее, для хранении данных пользователей понадобится порядка 57 Тб, а для хранения твитов - 18 Пб.

Основными данными являются медиафайлы, которые предполагается хранить в облачном хранилище Amazon S3. Максимальный размер бакета составляет 5 Тб [[13]](https://aws.amazon.com/ru/s3/faqs/#:~:text=S3%20%D0%BC%D0%BE%D0%B6%D0%B5%D1%82%20%D1%81%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D1%8F%D1%82%D1%8C-,%D0%BE%D1%82%200%C2%A0%D0%B1%D0%B0%D0%B9%D1%82%20%D0%B4%D0%BE%205%C2%A0%D0%A2%D0%91,-.%20%D0%A1%D0%B0%D0%BC%D1%8B%D0%B9%20%D0%BA%D1%80%D1%83%D0%BF%D0%BD%D1%8B%D0%B9%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82). Рассчитаем количество бакетов:

```
18 Пб / 5 Тб = 3,6к, учитывая запас на рост хранлища, хранения логов, метрик и прочего - 7к бакетов
```

| Amazon S3 | Количество бакетов|
|-|-|
| Хранилище данных| 7 000 |

Согласно данным на сайте Amazon S3 [[14]](https://aws.amazon.com/ru/s3/pricing/#:~:text=Frequent%20Access%20Tier%2C%20Over,%240.021%20per%20GB), аренда одного Гб часто используемых данных более 500 Тб/месяц будет стоить `$0.021` ~ `1,33 рублей`. Значит, хранение 7к бакетов будет стоить:
```
7к * 5 Тб * 1024 * 1,33 ~= 47 667 200 рублей
```

**Брокер сообщений**

В брокере сообщений будут храниться лайки до того, как попадут в микросервис лайков и запишутся в Redis. По результатам тестирования на машине с 8 CPU, 64 GB RAM, 2 * 2500 Gb SSD выдерживает более 655 Mb/s сетевого трафика, что покрывает рассчитанную нагрузку. Для обеспечения надежности необходимо предусмотреть несколько реплик.

| CPU | RAM (ГБ) | Диск (ГБ) | Количество |
|-|-|-|-|
| 8 | 64 | 2 * 2500 Gb SSD| 3 |

**PostgreSQL**

Основные часть занимаемых данных размещена в облаке, поэтому для выбора машин для PostgreSQL нужно сделать упор на скорость записи и чтения. Также необходимо учесть, что предполагается шардирование постов по временному диапазону, а также шардирование пользователей по их уникальному идентификатору.

Используя данные статьи [[14]](https://www.percona.com/blog/2017/01/06/millions-queries-per-second-postgresql-and-mysql-peaceful-battle-at-modern-demanding-workloads/), можно определить, что PostgreSQL может выдерживать порядка 40к TPS. Не все запросы к базе данных будут использовать транзакции, поэтому вполне вероятно, что несколько реплик с такой конфигурацией справятся с нагрузкой.

| CPU | RAM (ГБ) | Диск (ТБ) | Количество |
|-|-|-|-|
| 12 | 128 | 5 | 10 - на лайки, 10 - на посты, 5 - на пользователей |

**Redis**

Redis является in-memory хранилищем, поэтому требуется большой объем оперативной памяти. Для обеспечения хранения 238 млн сессионных токенов (количество пользователей в день) воспользуемся следующей конфигурацией:

| CPU | RAM (ГБ) | Диск (ГБ) | Количество |
|-|-|-|-|
| 6 | 128 | 50 | 10 |

**Балансировка**

Nginx может выдерживать порядка 50к RPS [[16]](https://rohitgupta.xyz/blog/tuning-nginx-for-better-rps-of-an-http-api/). Для обеспечения отказоустойчивости и надежности предусмотрим несколько реплик.

Для того, чтобы выдержать сетевой трафик, воспользуемся 100 Гб сетевыми картами. Учитывая объем сетевого трафика, количество серверов составит:
`3762 / 100 = 50 серверов, с запасом для обеспечения отказоустойчивости и надежности`

| Network | Количество |
|-|-|
| 100 Gb | 50 |
